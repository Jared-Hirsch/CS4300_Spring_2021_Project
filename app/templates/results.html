<html>

<head>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="/static/main.css">
  <link rel="stylesheet" href="/static/results.css">
  <link rel="icon" href="/static/logo.png">
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <title>simplay</title>
</head>

<body>
  <!-- Nav -->
  <nav id="nav">
    <div class="nav-container">
      <a href="/">
        <span class="nav-sides">
          <img src="/static/logo.png" id="nav-logo">
          <p id="nav-name">simplay</p>
        </span>
      </a>
      <span>
        <form action="results" onsubmit="modifyParameters()" name='results'>
          <div class="input-container">
            <input type="text" class="query" id="query" name="input_query"
              value="{{ results[0]['artist_name'] }} | {{ results[0]['track_name'] }}"
              placeholder="Artist Name | Song Name">
            <i class="fa fa-search" id="search-icon"></i>
          </div>
          <input type="hidden" name="lyrical_sim" min="0" max="100" value="50" id="lyr">
          <input type="hidden" name="duration" min="1" max="20" value="2">
          {% for af in audiofeatures %}
          <tr>
            <td> <input type="hidden" name="{{ af[1] }}" min="0" max="100" value="100" id="{{ af[1] }}"> </td>
          </tr>
          {% endfor %}
          <button type="submit" class="btn" id="btn-prim"> Create my Playlist </button>
        </form>
      </span>
      <span class="nav-sides" id="nav-logo"> </span>
    </div>
  </nav>

  <!-- Spotify modal -->
  <div class="modal">
    <form>
      <p class="label">Playlist Name</p>
      <input type="text" class="playlistname" id="playlistname" name="playlist_name" value="my simPlaylist"
        placeholder="my simPlaylist">

      <p class="label">Privacy</p>
      <input type="radio" id="private" name="privacy" value="private" checked>
      <label for="private">Private</label><br>
      <input type="radio" id="public" name="privacy" value="public">
      <label for="public">Public</label><br>

      <div class="spotify-cta">
        <!-- TODO: fix id properties as currently there is conflict  -->
        <button type="submit" class="btn" id="btn-prim2"> Save on Spotify </button>
      </div>
    </form>
  </div>

  <!-- Tint -->
  <div id="tint"></div>

  <!-- Playlist heading -->
  <div class="container">
    <div class="heading">
      <span>
        <h3>Playlist similar to...</h3>
        <h2>{{ results[0]['track_name'] }}</h2>
        <h3>by {{ results[0]['artist_name'] }} </h3>
      </span>
      <span>
        <label class="toggle">
          <p class="label">Detail Mode</p>
          <div class="switch">
            <input type="checkbox" onclick="changeMode()">
            <span class=" slider">
            </span>
          </div>
        </label>
      </span>
    </div>

    <!-- Results overview mode -->
    <div class="resultsshow" id="overviewcontent">
      <table>
        <tr>
          <th class="label">Song Title</th>
          <th class="label">Artist</th>
        </tr>

        {% for res in results[1] %}
        <tr class="song_row" id="{{ res[1]['track_id'] }}" onclick="open_spot(this.id);" style="cursor:hand">
          <td> {{ res[1]['track_name'] }} </td>
          <td> {{ res[1]['artist_name'] }} </td>
        </tr>
        {% endfor %}
      </table>
    </div>

    <!-- Results detail mode-->
    <div class="resultshide" id="detailcontent">
      <table>
        <tr>
          <th class="label">Song</th>
          <th class="label">Audio Similarity</th>
          <th class="label">Lyrical Similarity Score</th>
        </tr>

        {% for res in results[1] %}
        <tr>
          <td class="song_row" id="{{ res[1]['track_id'] }}" onclick="open_spot(this.id);">
            {{ res[1]['track_name'] }}
            <p style="color: #696969; font-size: 14; margin-top: 5;">
              {{ res[1]['artist_name'] }}
            </p>
          </td>

          <td>
            {{  res[0] }} <br>
            <svg width="300" height="300" id="{{ res[0] }} bar graph"></svg>
          </td>

          <td> {{ results[2][loop.index0] }} </td>
        </tr>
        {% endfor %}

      </table>
    </div>
  </div>

  <!-- Footer -->
  <footer>
    <span>Created by:</span>
    {% for student in students %}
    {% if loop.index == 4 %}
    <span>{{ student[0] }}</span>
    {% elif loop.index == 3 %}
    <span>{{ student[0] }}, and </span>
    {% else %}
    <span>{{ student[0] }}, </span>
    {% endif %}
    {% endfor %}
  </footer>

</body>

<script>
  // Open spotify links
  function open_spot(uri) {
    window.open("https://open.spotify.com/track/" + uri, '_blank');
  }

  // Toggle detail mode
  function changeMode() {
    var overview_el = document.getElementById("overviewcontent");
    var detail_el = document.getElementById("detailcontent");

    if (overview_el.getAttribute("class") == "resultsshow") {
      overview_el.setAttribute("class", "resultshide")
      detail_el.setAttribute("class", "resultsshow")
    }
    else {
      overview_el.setAttribute("class", "resultsshow");
      detail_el.setAttribute("class", "resultshide");
    }
  }

  // Open new search
  document.getElementById('query').onclick = function () {
    document.getElementById('query').style.width = '500';
    document.getElementById('nav').style.height = '150px';
    document.getElementById('search-icon').style.visibility = 'hidden';
    document.getElementById('btn-prim').style.display = 'block';
    document.getElementById('tint').style.display = 'block';
    document.getElementById('query').style.cursor = 'text';
  };
  // Close new search
  document.getElementById('tint').onclick = function () {
    document.getElementById('query').style.width = '400';
    document.getElementById('nav').style.height = '70px';
    document.getElementById('search-icon').style.visibility = 'visible';
    document.getElementById('btn-prim').style.display = 'none';
    document.getElementById('tint').style.display = 'none';
    document.getElementById('query').style.cursor = 'pointer';
  };
</script>

<script>
  // Modify parameters passed to query using current values and Rocchio update rule
  function modifyParameters(){
    const urlParams = new URLSearchParams(window.location.search);
    document.results.duration.value = urlParams.get('duration')
    document.results.auc.value = urlParams.get('auc')
    document.results.dnc.value = urlParams.get('duration')
    document.results.enr.value = urlParams.get('enr')
    document.results.ins.value = urlParams.get('ins')
    document.results.liv.value = urlParams.get('liv')
    document.results.loud.value = urlParams.get('loud')
    document.results.spch.value = urlParams.get('spch')
    document.results.temp.value = urlParams.get('temp')
    document.results.val.value = urlParams.get('val')
  }
</script>

<script>
  // Bar Graphs
  var svg = d3.selectAll("svg"),
      margin = {top: 10, right: 10, bottom: 50, left: 20},
      width = svg.attr("width") - margin.left - margin.right,
      height = svg.attr("height") - margin.top - margin.bottom;

  svg.append("g")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform",
          "translate(" + margin.left + "," + margin.top + ")")

  // TODO: figure out how to transpose data from html tags to here
  // TODO: re-format data to be in this format
  fafa = [{'attribute': 'acousticness','value':  0.8824,},{'attribute': 'danceability','value': 0.952},{'attribute': 'energy', 'value':0.885,},
  {'attribute': 'instrumentalness', 'value':1.0,}, {'attribute': 'liveness', 'value':0.992,}, {'attribute': 'speechiness', 'value':0.999,},
  {'attribute': 'valence', 'value': 0.833}]

  var x = d3.scaleBand().range([0, width]).padding(0.2).domain(fafa.map(function(d) { return d.attribute }));

  svg.append("g")
    .attr("transform", "translate(0," + height + ")")
    .call(d3.axisBottom(x))
    .selectAll("text")
    .attr("transform", "translate(-10,0)rotate(-45)")
    .style("text-anchor", "end");

  var y = d3.scaleLinear().range([height, 0]).domain([0, 1])

  svg.append("g").call(d3.axisLeft(y));

  svg.selectAll("mybar")
  .data(fafa)
  .enter()
  .append("rect")
    .attr("x", function(d) { return x(d.attribute); })
    .attr("y", function(d) { return y(d.value); })
    .attr("width", x.bandwidth())
    .attr("height", function(d) { return height - y(d.value); })
    .attr("fill", "#69b3a2")

</script>

</html>